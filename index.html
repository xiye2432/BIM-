<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIMå¹•å¢™å›¢é˜Ÿè¿›åº¦ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Microsoft YaHei', sans-serif; }
        body { margin: 0; background-color: #f5f7fa; }

        /* ç™»å½•å’Œæ³¨å†Œå®¹å™¨æ ·å¼ */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .auth-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 400px;
            max-width: 90%;
        }
        .auth-title {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 24px;
        }
        .auth-form input, .auth-form select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .auth-form input:focus, .auth-form select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
            outline: none;
        }
        .auth-form button {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .auth-error {
            color: #e74c3c;
            margin-bottom: 20px;
            text-align: center;
            padding: 10px;
            background: rgba(231,76,60,0.1);
            border-radius: 5px;
        }
        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #7f8c8d;
        }
        .auth-switch a {
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
        }

        /* ä¸»ç³»ç»Ÿæ ·å¼ */
        #mainSystem {
            display: none;
            min-height: 100vh;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            flex: 1;
            min-width: 300px;
        }
        h2 { color: #3498db; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .status-pending { color: #f39c12; }
        .status-done { color: #2ecc71; }
        .status-blocked { color: #e74c3c; }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
            font-size: 14px;
        }
        button.danger { background: #e74c3c; }
        button.success { background: #2ecc71; }
        button.warning { background: #f39c12; }
        .task-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .project-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 6px;
            background: #f8f9fa;
        }
        .gantt-bar {
            height: 20px;
            background: #3498db;
            border-radius: 3px;
            margin: 5px 0;
        }
        .admin-only { display: none; }
        .staff-only { display: none; }

        /* å›¢é˜Ÿä»»åŠ¡è¡¨æ ¼ä¼˜åŒ– */
        .team-tasks-table {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .team-tasks-table table {
            margin: 0;
        }
        .team-tasks-table th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
        .team-tasks-table td {
            padding: 8px 12px;
            font-size: 13px;
        }
        .team-tasks-table .task-content {
            max-width: 200px;
            word-wrap: break-word;
        }
        .team-tasks-table .status-cell {
            min-width: 80px;
        }
        .team-tasks-table .action-cell {
            min-width: 120px;
        }
        .team-tasks-table .name-cell {
            min-width: 80px;
        }
        .team-tasks-table .project-cell {
            min-width: 120px;
        }

        /* ä»»åŠ¡å¡ç‰‡æ ·å¼ */
        .task-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }
        .task-card.completed {
            border-left-color: #2ecc71;
        }
        .task-card.pending {
            border-left-color: #f39c12;
        }
        .task-card.blocked {
            border-left-color: #e74c3c;
        }
        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .task-card-title {
            font-weight: bold;
            color: #2c3e50;
        }
        .task-card-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .task-card-status.completed {
            background: #d5f4e6;
            color: #27ae60;
        }
        .task-card-status.pending {
            background: #fef9e7;
            color: #f39c12;
        }
        .task-card-status.blocked {
            background: #fadbd8;
            color: #e74c3c;
        }
        .task-card-content {
            color: #7f8c8d;
            font-size: 13px;
            line-height: 1.4;
        }
        .task-card-actions {
            margin-top: 8px;
            display: flex;
            gap: 5px;
        }
        .task-card-actions button {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* è§†å›¾åˆ‡æ¢æŒ‰é’® */
        .view-toggle {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        .view-toggle button {
            padding: 8px 16px;
            background: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
        }
        .view-toggle button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
        .edit-mode input, .edit-mode select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        .edit-buttons {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body>
<!-- ç™»å½•é¡µé¢ -->
<div class="auth-container" id="loginContainer">
    <div class="auth-box">
        <h2 class="auth-title">BIMå¹•å¢™å›¢é˜Ÿè¿›åº¦ç®¡ç†ç³»ç»Ÿ</h2>
        <div class="auth-error" id="loginError"></div>
        <form class="auth-form" id="loginForm">
            <input type="text" id="username" placeholder="çœŸå®å§“å" required>
            <input type="password" id="password" placeholder="å¯†ç " required>
            <button type="submit">ç™»å½•</button>
        </form>
        <div class="auth-switch">
            è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a onclick="showRegister()">ç«‹å³æ³¨å†Œ</a>
        </div>
        <div style="text-align: center; margin-top: 20px; color: #7f8c8d;">
            <div>ç®¡ç†å‘˜è´¦å·: ç®¡ç†å‘˜ å¯†ç : 123456</div>
            <div>æµ‹è¯•è´¦å·: å¼ ä¸‰ å¯†ç : 123</div>
            <div>æµ‹è¯•è´¦å·: æå›› å¯†ç : 123</div>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
    </div>
</div>

<!-- æ³¨å†Œé¡µé¢ -->
<div class="auth-container" id="registerContainer" style="display: none;">
    <div class="auth-box">
        <h2 class="auth-title">ç”¨æˆ·æ³¨å†Œ</h2>
        <div class="auth-error" id="registerError"></div>
        <form class="auth-form" id="registerForm">
            <input type="text" id="regName" placeholder="çœŸå®å§“åï¼ˆå°†ä½œä¸ºç™»å½•ç”¨æˆ·åï¼‰" required>
            <input type="password" id="regPassword" placeholder="å¯†ç " required>
            <input type="password" id="regConfirmPassword" placeholder="ç¡®è®¤å¯†ç " required>
            <button type="submit">æ³¨å†Œ</button>
        </form>
        <div class="auth-switch">
            å·²æœ‰è´¦å·ï¼Ÿ<a onclick="showLogin()">ç«‹å³ç™»å½•</a>
        </div>
    </div>
</div>

<!-- ä¸»ç³»ç»Ÿå†…å®¹ -->
<div id="mainSystem">
    <div class="header">
        <h1>BIMå¹•å¢™å›¢é˜Ÿè¿›åº¦ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="user-info">
            <span>æ¬¢è¿ï¼Œ<span id="currentUserName">ç”¨æˆ·</span> <small id="currentUserRole"></small></span>
            <button onclick="exportData()" style="background: #27ae60; margin-right: 10px;">å¯¼å‡ºæ•°æ®</button>
            <button onclick="openCloudConfig()" style="background: #2980b9; margin-right: 10px;" id="cloudCfgBtn" style="display:none;">äº‘ç«¯é…ç½®</button>
            <button onclick="showAdminPanel()" style="background: #9b59b6; margin-right: 10px;" id="adminPanelBtn" style="display: none;">ç®¡ç†å‘˜é¢æ¿</button>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="container">
        <!-- æ¯æ—¥ä»»åŠ¡å¡«æŠ¥ -->
        <div class="card staff-only">
            <h2>ğŸ“… ä»Šæ—¥ä»»åŠ¡å¡«æŠ¥</h2>
            <form id="dailyForm">
                <input type="date" id="taskDate" class="task-input" required>
                <select id="staff" class="task-input" required>
                    <option value="">--è¯·é€‰æ‹©--</option>
                </select>
                <select id="project" class="task-input" required>
                    <option value="">--è¯·é€‰æ‹©--</option>
                </select>
                <select id="mainTask" class="task-input">
                    <option value="">--é€‰æ‹©ä»»åŠ¡ç±»å‹--</option>
                    <option value="å®Œå–„è®¾è®¡">å®Œå–„è®¾è®¡</option>
                    <option value="ä¼˜åŒ–è®¾è®¡">ä¼˜åŒ–è®¾è®¡</option>
                    <option value="ç»“æ„æ¨¡å‹">ç»“æ„æ¨¡å‹</option>
                </select>
                <input type="text" id="taskDesc" class="task-input" placeholder="ä»»åŠ¡å…·ä½“æè¿°">

                <table id="taskTable">
                    <thead>
                    <tr>
                        <th>ä»»åŠ¡å†…å®¹</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="taskTableBody"></tbody>
                </table>
                <button type="button" class="success" onclick="addTaskRow()">æ·»åŠ ä»»åŠ¡</button>
                <button type="submit" class="success" style="float:right;">æäº¤ä»»åŠ¡</button>
            </form>
        </div>

        <!-- é¡¹ç›®æ€»è§ˆ -->
        <div class="card">
            <h2>ğŸ“Œ é¡¹ç›®æ€»è¿›åº¦</h2>
            <div style="margin: 20px 0;">
                <canvas id="progressChart" height="200"></canvas>
            </div>
            <div id="projectGanttContainer"></div>
            <h3>ğŸ“ ä»Šæ—¥å›¢é˜Ÿä»»åŠ¡</h3>
            
            <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
            <div class="view-toggle">
                <button id="tableViewBtn" class="active" onclick="switchView('table')">è¡¨æ ¼è§†å›¾</button>
                <button id="cardViewBtn" onclick="switchView('card')">å¡ç‰‡è§†å›¾</button>
                <button onclick="viewAllTasks()" style="background: #9b59b6;">æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡</button>
                <button onclick="forceDeleteTask('1756261185209')" style="background: #e67e22;">åˆ é™¤é—®é¢˜ä»»åŠ¡</button>
                <button onclick="fixTaskIdIssue()" style="background: #16a085;">ä¿®å¤IDé—®é¢˜</button>
                <button onclick="clearAllTasks()" style="background: #e74c3c;">æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡</button>
            </div>
            
            <!-- è¡¨æ ¼è§†å›¾ -->
            <div id="tableView" class="team-tasks-table">
                <table>
                    <thead>
                    <tr>
                        <th class="name-cell">å§“å</th>
                        <th class="project-cell">é¡¹ç›®</th>
                        <th class="task-content">ä»»åŠ¡å†…å®¹</th>
                        <th class="status-cell">çŠ¶æ€</th>
                        <th class="action-cell" id="adminActionHeader" style="display:none;">æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="teamTasksBody"></tbody>
                </table>
            </div>
            
            <!-- å¡ç‰‡è§†å›¾ -->
            <div id="cardView" style="display: none;">
                <div id="teamTasksCards"></div>
            </div>
        </div>

        <!-- é¡¹ç›®ç®¡ç† (ç®¡ç†å‘˜) -->
        <div class="card admin-only">
            <h2>ğŸ“‚ é¡¹ç›®ç®¡ç†</h2>
            <div>
                <input type="text" id="newProjectName" placeholder="é¡¹ç›®åç§°" class="task-input">
                <input type="text" id="newProjectManager" placeholder="è´Ÿè´£äºº" class="task-input">
                <button onclick="addProject()" class="success">æ·»åŠ é¡¹ç›®</button>
            </div>
            <h3>é¡¹ç›®åˆ—è¡¨</h3>
            <table>
                <thead>
                <tr>
                    <th>é¡¹ç›®åç§°</th>
                    <th>è¿›åº¦</th>
                    <th>è´Ÿè´£äºº</th>
                    <th>æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="projectList"></tbody>
            </table>
        </div>

        <!-- äººå‘˜ç®¡ç† (ç®¡ç†å‘˜) -->
        <div class="card admin-only">
            <h2>ğŸ‘¥ å›¢é˜Ÿäººå‘˜ç®¡ç†</h2>
            <div>
                <input type="text" id="newStaffName" placeholder="å§“å" class="task-input">
                <button onclick="addStaff()" class="success">æ·»åŠ æˆå‘˜</button>
            </div>
            <h3>æˆå‘˜åˆ—è¡¨</h3>
            <table>
                <thead>
                <tr>
                    <th>å§“å</th>
                    <th>å‚ä¸é¡¹ç›®</th>
                    <th>æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="staffList"></tbody>
            </table>
        </div>
    </div>
    <input type="file" id="importFileMain" accept=".json" style="display: none;" onchange="handleFileImport(event)">
    <!-- äº‘ç«¯é…ç½®å¼¹çª— -->
    <div id="cloudConfigModal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); align-items:center; justify-content:center;">
        <div style="background:#fff; padding:20px; border-radius:8px; width:420px;">
            <h3>äº‘ç«¯é…ç½®ï¼ˆSupabaseï¼‰</h3>
            <div style="margin:10px 0;">
                <input id="cfgUrl" class="task-input" placeholder="Supabase URL"/>
                <input id="cfgKey" class="task-input" placeholder="Supabase anon key"/>
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button onclick="saveCloudConfig()" class="success">ä¿å­˜å¹¶åŒæ­¥</button>
                <button onclick="manualPull()">ä»äº‘ç«¯æ‹‰å–</button>
                <button onclick="manualPush()">æ¨é€åˆ°äº‘ç«¯</button>
                <button class="danger" onclick="closeCloudConfig()">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<script>
    // æ•°æ®å­˜å‚¨é”®å
    const DATA_KEY = 'bim_system_data';
    const USERS_KEY = 'bim_system_users';
    let currentUser = null;
    let chart = null;
    let editingTaskId = null;

    // äº‘ç«¯é…ç½®ï¼ˆç›´æ¥å›ºå®šåœ¨ä»£ç ä¸­ï¼‰
    const SUPABASE_URL = 'https://ulqmodtnpqvwaocjpeiw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVscW1vZHRucHF2d2FvY2pwZWl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyODcyNTYsImV4cCI6MjA3MTg2MzI1Nn0.Hp95Eob5QjgjgT1CW4TSSIJ3xRQEsgKh5fgmER0q9Bo';
    let sb = null; // Supabase å®¢æˆ·ç«¯

    async function initCloud() {
        if (!window.supabase || !SUPABASE_URL || !SUPABASE_ANON_KEY) return;
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        try {
            // ä½¿ç”¨ä¸€å¼ ç®€å•çš„ KV è¡¨ï¼šapp_kv(key text primary key, value jsonb)
            // è¿™é‡Œå‡è®¾å·²åœ¨ Supabase æ§åˆ¶å°åˆ›å»ºè¯¥è¡¨ï¼Œå¹¶å…è®¸ anon è¯»å†™
            await cloudPull();
        } catch (e) {
            console.warn('Cloud init failed:', e);
        }
    }

    async function cloudPull() {
        if (!sb) return;
        const { data, error } = await sb.from('app_kv').select('key,value').in('key', [USERS_KEY, DATA_KEY]);
        if (error) { console.warn('Cloud pull error', error); return; }
        const map = Object.fromEntries((data || []).map(r => [r.key, r.value]));
        if (map[USERS_KEY]) localStorage.setItem(USERS_KEY, JSON.stringify(map[USERS_KEY]));
        if (map[DATA_KEY]) localStorage.setItem(DATA_KEY, JSON.stringify(map[DATA_KEY]));
    }

    async function cloudPush(key, value) {
        if (!sb) return;
        const payload = { key, value };
        const { error } = await sb.from('app_kv').upsert(payload);
        if (error) console.warn('Cloud push error', key, error);
    }

    function saveUsers(users) {
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
        cloudPush(USERS_KEY, users);
    }

    // ç®€å•çš„å¯†ç åŠ å¯†å‡½æ•°
    function simpleEncrypt(password) {
        return btoa(encodeURIComponent(password));
    }

    // ç®€å•çš„å¯†ç è§£å¯†å‡½æ•°
    function simpleDecrypt(encrypted) {
        return decodeURIComponent(atob(encrypted));
    }

    // åˆå§‹åŒ–ç³»ç»Ÿ
    document.addEventListener('DOMContentLoaded', async function() {
        // äº‘ç«¯ä¼˜å…ˆï¼šå¦‚é…ç½®äº† Supabaseï¼Œåˆ™å…ˆä»äº‘ç«¯æ‹‰å–è¦†ç›–æœ¬åœ°
        await initCloud();
        // ç¡®ä¿åˆå§‹åŒ–æ•°æ®ï¼ˆè‹¥äº‘ç«¯æ²¡æœ‰æ•°æ®ä¼šèµ°æœ¬åœ°åˆå§‹åŒ–ï¼‰
        initSystemData();
        initUsersData();

        // è®¾ç½®æµ‹è¯•è´¦å·
        document.getElementById('username').value = 'ç®¡ç†å‘˜';
        document.getElementById('password').value = '123456';

        initLogin();
        initRegister();
    });

    // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
    function initUsersData() {
        let users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        
        // ç¡®ä¿ç®¡ç†å‘˜è´¦å·å­˜åœ¨
        if (!users['ç®¡ç†å‘˜']) {
            users['ç®¡ç†å‘˜'] = {
                name: 'ç®¡ç†å‘˜',
                password: simpleEncrypt('123456'),
                role: 'admin'
            };
        }
        
        // ç¡®ä¿æµ‹è¯•è´¦å·å­˜åœ¨
        if (!users['å¼ ä¸‰']) {
            users['å¼ ä¸‰'] = {
                name: 'å¼ ä¸‰',
                password: simpleEncrypt('123'),
                role: 'staff'
            };
        }
        
        if (!users['æå››']) {
            users['æå››'] = {
                name: 'æå››',
                password: simpleEncrypt('123'),
                role: 'staff'
            };
        }
        
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
    }

    // åˆå§‹åŒ–ç³»ç»Ÿæ•°æ®
    function initSystemData() {
        if (!localStorage.getItem(DATA_KEY)) {
            const data = {
                projects: [
                    { id: 1, name: "ä¸Šæµ·é‡‘èä¸­å¿ƒå¹•å¢™", progress: 65, manager: "å¼ ä¸‰" },
                    { id: 2, name: "æ­å·äºšè¿åœºé¦†å¤–ç«‹é¢", progress: 30, manager: "æå››" }
                ],
                staff: [
                    {
                        id: 1,
                        name: "å¼ ä¸‰",
                        projects: [1]
                    },
                    {
                        id: 2,
                        name: "æå››",
                        projects: [2]
                    }
                ],
                tasks: [
                    {
                        id: 1,
                        date: new Date().toISOString().split('T')[0],
                        staff: 1,
                        project: 1,
                        tasks: [
                            { mainTask: "ä¼˜åŒ–è®¾è®¡", description: "å¹•å¢™ç»“æ„ä¼˜åŒ–", status: "è¿›è¡Œä¸­" }
                        ]
                    },
                    {
                        id: 2,
                        date: new Date().toISOString().split('T')[0],
                        staff: 2,
                        project: 2,
                        tasks: [
                            { mainTask: "å®Œå–„è®¾è®¡", description: "å¤–ç«‹é¢ç»†èŠ‚å®Œå–„", status: "å·²å®Œæˆ" }
                        ]
                    }
                ]
            };
            localStorage.setItem(DATA_KEY, JSON.stringify(data));
        }
    }

    // åˆå§‹åŒ–ç™»å½•åŠŸèƒ½
    function initLogin() {
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');

            if (users[username] && simpleDecrypt(users[username].password) === password) {
                currentUser = {
                    username: username,
                    name: users[username].name,
                    role: users[username].role
                };
                showMainSystem();
            } else {
                document.getElementById('loginError').textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
            }
        });
    }

    // åˆå§‹åŒ–æ³¨å†ŒåŠŸèƒ½
    function initRegister() {
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (password !== confirmPassword) {
                document.getElementById('registerError').textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                return;
            }

            const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');

            if (users[name]) {
                document.getElementById('registerError').textContent = 'è¯¥å§“åå·²è¢«æ³¨å†Œ';
                return;
            }

            // æ·»åŠ æ–°ç”¨æˆ· - ä½¿ç”¨çœŸå®å§“åä½œä¸ºç”¨æˆ·å
            users[name] = {
                name: name,
                password: simpleEncrypt(password),
                role: 'staff'  // é»˜è®¤æ³¨å†Œä¸ºæ™®é€šæˆå‘˜
            };

            saveUsers(users);

            // åŒæ—¶æ·»åŠ åˆ°ç³»ç»Ÿæ•°æ®ä¸­çš„staffåˆ—è¡¨
            const data = getSystemData();
            const newStaff = {
                id: Date.now(),
                name: name,
                projects: []
            };
            data.staff.push(newStaff);
            saveSystemData(data);

            alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ä½¿ç”¨çœŸå®å§“åç™»å½•');
            showLogin();
        });
    }

    // æ˜¾ç¤ºæ³¨å†Œé¡µé¢
    function showRegister() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('registerContainer').style.display = 'flex';
        document.getElementById('registerError').textContent = '';
        document.getElementById('registerForm').reset();
    }

    // æ˜¾ç¤ºç™»å½•é¡µé¢
    function showLogin() {
        document.getElementById('registerContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('loginError').textContent = '';
        document.getElementById('loginForm').reset();
    }

    // è·å–ç³»ç»Ÿæ•°æ®
    function getSystemData() {
        return JSON.parse(localStorage.getItem(DATA_KEY));
    }

    // ä¿å­˜ç³»ç»Ÿæ•°æ®
    function saveSystemData(data) {
        localStorage.setItem(DATA_KEY, JSON.stringify(data));
        cloudPush(DATA_KEY, data);
    }

    // æ˜¾ç¤ºä¸»ç³»ç»Ÿ
    function showMainSystem() {
        document.getElementById('loginError').textContent = '';
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainSystem').style.display = 'block';
        document.getElementById('currentUserName').textContent = currentUser.name;
        document.getElementById('currentUserRole').textContent = `(${currentUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æˆå‘˜'})`;

        // æƒé™æ§åˆ¶
        const isAdmin = currentUser.role === 'admin';
        document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = isAdmin ? 'block' : 'none';
        });
        document.querySelectorAll('.staff-only').forEach(el => {
            el.style.display = 'block'; // æˆå‘˜å’Œç®¡ç†å‘˜éƒ½èƒ½çœ‹åˆ°
        });

        // æ˜¾ç¤ºç®¡ç†å‘˜æ“ä½œåˆ—
        document.getElementById('adminActionHeader').style.display = isAdmin ? 'table-cell' : 'none';
        
        // æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿æŒ‰é’®
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        if (adminPanelBtn) {
            adminPanelBtn.style.display = isAdmin ? 'inline-block' : 'none';
        }
        // äº‘ç«¯é…ç½®æŒ‰é’® - å·²å›ºå®šåœ¨ä»£ç ä¸­ï¼Œéšè—æŒ‰é’®
        const cloudCfgBtn = document.getElementById('cloudCfgBtn');
        if (cloudCfgBtn) cloudCfgBtn.style.display = 'none';

        initMainSystem();
    }

    // äº‘ç«¯é…ç½® UI
    function openCloudConfig() {
        document.getElementById('cfgUrl').value = localStorage.getItem('sb_url') || '';
        document.getElementById('cfgKey').value = localStorage.getItem('sb_key') || '';
        document.getElementById('cloudConfigModal').style.display = 'flex';
    }
    function closeCloudConfig() {
        document.getElementById('cloudConfigModal').style.display = 'none';
    }
    async function saveCloudConfig() {
        const url = document.getElementById('cfgUrl').value.trim();
        const key = document.getElementById('cfgKey').value.trim();
        localStorage.setItem('sb_url', url);
        localStorage.setItem('sb_key', key);
        alert('å·²ä¿å­˜äº‘ç«¯é…ç½®ï¼Œå¼€å§‹åŒæ­¥...');
        await initCloud();
        await manualPush();
        closeCloudConfig();
    }
    async function manualPull() { await cloudPull(); alert('å·²ä»äº‘ç«¯æ‹‰å–å®Œæˆ'); }
    async function manualPush() {
        const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        const data = JSON.parse(localStorage.getItem(DATA_KEY) || '{}');
        await cloudPush(USERS_KEY, users);
        await cloudPush(DATA_KEY, data);
        alert('å·²æ¨é€åˆ°äº‘ç«¯');
    }

    // åˆå§‹åŒ–ä¸»ç³»ç»Ÿ
    function initMainSystem() {
        // å…ˆå¯¹é½ç”¨æˆ·ä¸æˆå‘˜æ•°æ®ï¼Œå¹¶è§„èŒƒåŒ– ID ç±»å‹
        reconcileUsersAndStaff();
        normalizeDataIds();
        const data = getSystemData();

        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('taskDate').valueAsDate = new Date();

        // åˆå§‹åŒ–å›¢é˜Ÿæˆå‘˜ä¸‹æ‹‰èœå•
        updateStaffSelect(data.staff);

        // å¦‚æœæ˜¯æ™®é€šæˆå‘˜ï¼Œè‡ªåŠ¨é€‰æ‹©è‡ªå·±
        if(currentUser.role === 'staff') {
            const staff = data.staff.find(s => s.name === currentUser.name);
            if(staff) {
                document.getElementById('staff').value = staff.id;
                document.getElementById('staff').disabled = true;
            }
        }

        // åˆå§‹åŒ–é¡¹ç›®ä¸‹æ‹‰èœå•
        updateProjectSelect(data.projects);

        // åˆå§‹åŒ–å›¾è¡¨
        initChart(data.projects);

        // åˆå§‹åŒ–ä»Šæ—¥å›¢é˜Ÿä»»åŠ¡è¡¨æ ¼
        updateTeamTasksTable(data.tasks);

        // åˆå§‹åŒ–é¡¹ç›®åˆ—è¡¨
        updateProjectList(data.projects);

        // åˆå§‹åŒ–æˆå‘˜åˆ—è¡¨
        updateStaffList(data.staff, data.projects);

        // åˆå§‹åŒ–é¡¹ç›®ç”˜ç‰¹å›¾
        updateProjectGantt(data.projects);

        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document.getElementById('dailyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitDailyForm(data);
        });
    }

    // æ›´æ–°äººå‘˜ä¸‹æ‹‰èœå•
    function updateStaffSelect(staff) {
        const staffSelect = document.getElementById('staff');
        const options = (staff || [])
            .filter(s => s.name !== 'ç®¡ç†å‘˜')
            .map(s => `<option value="${s.id}">${s.name}</option>`)
            .join('');
        staffSelect.innerHTML = '<option value="">--è¯·é€‰æ‹©--</option>' + options;
    }

    // æ›´æ–°é¡¹ç›®ä¸‹æ‹‰èœå•
    function updateProjectSelect(projects) {
        const projectSelect = document.getElementById('project');
        projectSelect.innerHTML = '<option value="">--è¯·é€‰æ‹©--</option>' +
            projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }

    // åˆå§‹åŒ–å›¾è¡¨
    function initChart(projects) {
        const ctx = document.getElementById('progressChart').getContext('2d');
        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: projects.map(p => p.name),
                datasets: [{
                    label: 'é¡¹ç›®è¿›åº¦ (%)',
                    data: projects.map(p => p.progress),
                    backgroundColor: projects.map(p =>
                        p.progress > 70 ? '#2ecc71' :
                            p.progress > 30 ? '#3498db' : '#e74c3c'
                    ),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // æ›´æ–°é¡¹ç›®åˆ—è¡¨
    function updateProjectList(projects) {
        const tbody = document.getElementById('projectList');
        tbody.innerHTML = '';

        projects.forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.progress}%</td>
                    <td>${p.manager}</td>
                    <td><button class="danger" onclick="deleteProject(${p.id})">åˆ é™¤</button></td>
                `;
            tbody.appendChild(row);
        });
    }

    // æ›´æ–°æˆå‘˜åˆ—è¡¨
    function updateStaffList(staff, projects) {
        const tbody = document.getElementById('staffList');
        tbody.innerHTML = '';
        const visibleStaff = (staff || []).filter(s => s.name !== 'ç®¡ç†å‘˜');
        visibleStaff.forEach(s => {
            const projectNames = s.projects.map(pid =>
                projects.find(p => p.id === pid)?.name || pid
            ).join(', ');

            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${s.name}</td>
                    <td>${projectNames || 'æ— '}</td>
                    <td>
                        <button class="danger" onclick="deleteStaff(${s.id})">åˆ é™¤</button>
                    </td>
                `;
            tbody.appendChild(row);
        });
    }

    // æ›´æ–°å›¢é˜Ÿä»»åŠ¡è¡¨æ ¼
    function updateTeamTasksTable(tasks) {
        const today = new Date().toISOString().split('T')[0];
        const data = getSystemData();
        const todayTasks = tasks.filter(t => t.date === today);

        const tbody = document.getElementById('teamTasksBody');
        tbody.innerHTML = '';

        const cardsContainer = document.getElementById('teamTasksCards');
        cardsContainer.innerHTML = '';

        todayTasks.forEach(task => {
            // å…¼å®¹å­—ç¬¦ä¸²/æ•°å­—ç±»å‹ä¸ä¸€è‡´ï¼Œè½¬ä¸ºå­—ç¬¦ä¸²æ¯”è¾ƒ
            const staff = data.staff.find(s => String(s.id) === String(task.staff));
            const project = data.projects.find(p => p.id === task.project);

            task.tasks.forEach((t, index) => {
                const taskId = `${task.id}-${index}`;
                const statusClass = t.status === 'å·²å®Œæˆ' ? 'done' : t.status === 'è¿›è¡Œä¸­' ? 'pending' : 'blocked';
                const cardStatusClass = t.status === 'å·²å®Œæˆ' ? 'completed' : t.status === 'è¿›è¡Œä¸­' ? 'pending' : 'blocked';

                // è¡¨æ ¼è¡Œ
                const row = document.createElement('tr');
                row.innerHTML = `
                        <td class="name-cell">${staff?.name || task.staff}</td>
                        <td class="project-cell">${project?.name || task.project}</td>
                        <td class="task-content">${t.mainTask}: ${t.description}</td>
                        <td class="status-cell status-${statusClass}">${t.status}</td>
                        ${currentUser.role === 'admin' ?
                    `<td class="action-cell edit-buttons">
                                <button class="warning" onclick="editTask('${taskId}')">ç¼–è¾‘</button>
                                <button class="danger" onclick="deleteTask('${taskId}')">åˆ é™¤</button>
                            </td>` : ''
                }
                    `;
                tbody.appendChild(row);

                // å¡ç‰‡è§†å›¾
                const card = document.createElement('div');
                card.className = `task-card ${cardStatusClass}`;
                card.innerHTML = `
                    <div class="task-card-header">
                        <div class="task-card-title">${staff?.name || task.staff} - ${project?.name || task.project}</div>
                        <div class="task-card-status ${cardStatusClass}">${t.status}</div>
                    </div>
                    <div class="task-card-content">
                        <strong>${t.mainTask}:</strong> ${t.description}
                    </div>
                    ${currentUser.role === 'admin' ?
                    `<div class="task-card-actions">
                        <button class="warning" onclick="editTask('${taskId}')">ç¼–è¾‘</button>
                        <button class="danger" onclick="deleteTask('${taskId}')">åˆ é™¤</button>
                    </div>` : ''
                }
                `;
                cardsContainer.appendChild(card);
            });
        });
    }

    // è§„èŒƒåŒ–æ•°æ®ä¸­çš„ ID ç±»å‹ï¼Œç¡®ä¿ä¸ºæ•°å­—ï¼Œé¿å…åŒ¹é…å¤±è´¥
    function normalizeDataIds() {
        const data = getSystemData();
        if (!data) return;
        let changed = false;

        if (Array.isArray(data.staff)) {
            data.staff.forEach(s => {
                if (s && typeof s.id === 'string') {
                    const n = parseInt(s.id);
                    if (!Number.isNaN(n)) { s.id = n; changed = true; }
                }
            });
        }

        if (Array.isArray(data.tasks)) {
            data.tasks.forEach(t => {
                if (t && typeof t.staff === 'string') {
                    const n = parseInt(t.staff);
                    if (!Number.isNaN(n)) { t.staff = n; changed = true; }
                }
            });
        }

        if (changed) {
            saveSystemData(data);
        }
    }

    // å¯¹é½ users ä¸ systemData.staffï¼Œç¡®ä¿æ¯ä¸ªç”¨æˆ·åœ¨æˆå‘˜åˆ—è¡¨ä¸­
    function reconcileUsersAndStaff() {
        const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        const data = getSystemData();
        if (!data) return;

        let changed = false;
        // å…ˆç§»é™¤è¯¯åŠ è¿›æ¥çš„ç®¡ç†å‘˜é¡¹
        data.staff = (data.staff || []).filter(s => s.name !== 'ç®¡ç†å‘˜');
        const staffNames = new Set((data.staff || []).map(s => s.name));

        Object.keys(users).forEach(username => {
            const user = users[username];
            if (!user) return;
            if (!staffNames.has(user.name)) {
                const newStaff = { id: Date.now(), name: user.name, projects: [] };
                if (!Array.isArray(data.staff)) data.staff = [];
                data.staff.push(newStaff);
                staffNames.add(user.name);
                changed = true;
            }
        });

        if (changed) {
            saveSystemData(data);
        }
    }

    // ç¼–è¾‘ä»»åŠ¡
    function editTask(taskId) {
        if (editingTaskId) {
            alert('è¯·å…ˆå®Œæˆå½“å‰ç¼–è¾‘ä»»åŠ¡');
            return;
        }

        editingTaskId = taskId;
        const [taskIndex, subTaskIndex] = taskId.split('-').map(Number);
        const data = getSystemData();
        const task = data.tasks.find(t => t.id === taskIndex);

        if (!task) return;

        const subTask = task.tasks[subTaskIndex];
        
        // æŸ¥æ‰¾è¡¨æ ¼ä¸­çš„è¡Œ
        const tableRow = document.querySelector(`#teamTasksBody tr:has(button[onclick="editTask('${taskId}')"])`);
        if (tableRow) {
            tableRow.classList.add('edit-mode');
            tableRow.innerHTML = `
                    <td class="name-cell">
                        <select id="editStaff-${taskId}">
                            ${data.staff.map(s => `<option value="${s.id}" ${s.id === task.staff ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                    </td>
                    <td class="project-cell">
                        <select id="editProject-${taskId}">
                            ${data.projects.map(p => `<option value="${p.id}" ${p.id === task.project ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </td>
                    <td class="task-content">
                        <input type="text" id="editTaskDesc-${taskId}" value="${subTask.mainTask}: ${subTask.description}">
                    </td>
                    <td class="status-cell">
                        <select id="editStatus-${taskId}">
                            <option value="æœªå¼€å§‹" ${subTask.status === 'æœªå¼€å§‹' ? 'selected' : ''}>æœªå¼€å§‹</option>
                            <option value="è¿›è¡Œä¸­" ${subTask.status === 'è¿›è¡Œä¸­' ? 'selected' : ''}>è¿›è¡Œä¸­</option>
                            <option value="å·²å®Œæˆ" ${subTask.status === 'å·²å®Œæˆ' ? 'selected' : ''}>å·²å®Œæˆ</option>
                            <option value="å·²é˜»å¡" ${subTask.status === 'å·²é˜»å¡' ? 'selected' : ''}>å·²é˜»å¡</option>
                        </select>
                    </td>
                    <td class="action-cell edit-buttons">
                        <button class="success" onclick="saveTask('${taskId}')">ä¿å­˜</button>
                        <button class="danger" onclick="cancelEdit('${taskId}')">å–æ¶ˆ</button>
                    </td>
                `;
        }

        // åŒæ—¶æ›´æ–°å¡ç‰‡è§†å›¾ä¸­çš„å¯¹åº”å¡ç‰‡
        const cardElement = document.querySelector(`#teamTasksCards .task-card:has(button[onclick="editTask('${taskId}')"])`);
        if (cardElement) {
            cardElement.innerHTML = `
                <div class="task-card-header">
                    <div class="task-card-title">ç¼–è¾‘ä»»åŠ¡</div>
                </div>
                <div style="margin-bottom: 10px;">
                    <select id="editStaffCard-${taskId}" style="width: 100%; margin-bottom: 5px;">
                        ${data.staff.map(s => `<option value="${s.id}" ${s.id === task.staff ? 'selected' : ''}>${s.name}</option>`).join('')}
                    </select>
                    <select id="editProjectCard-${taskId}" style="width: 100%; margin-bottom: 5px;">
                        ${data.projects.map(p => `<option value="${p.id}" ${p.id === task.project ? 'selected' : ''}>${p.name}</option>`).join('')}
                    </select>
                    <input type="text" id="editTaskDescCard-${taskId}" value="${subTask.mainTask}: ${subTask.description}" style="width: 100%; margin-bottom: 5px;">
                    <select id="editStatusCard-${taskId}" style="width: 100%; margin-bottom: 5px;">
                        <option value="æœªå¼€å§‹" ${subTask.status === 'æœªå¼€å§‹' ? 'selected' : ''}>æœªå¼€å§‹</option>
                        <option value="è¿›è¡Œä¸­" ${subTask.status === 'è¿›è¡Œä¸­' ? 'selected' : ''}>è¿›è¡Œä¸­</option>
                        <option value="å·²å®Œæˆ" ${subTask.status === 'å·²å®Œæˆ' ? 'selected' : ''}>å·²å®Œæˆ</option>
                        <option value="å·²é˜»å¡" ${subTask.status === 'å·²é˜»å¡' ? 'selected' : ''}>å·²é˜»å¡</option>
                    </select>
                </div>
                <div class="task-card-actions">
                    <button class="success" onclick="saveTask('${taskId}')">ä¿å­˜</button>
                    <button class="danger" onclick="cancelEdit('${taskId}')">å–æ¶ˆ</button>
                </div>
            `;
        }
    }

    // ä¿å­˜ä»»åŠ¡ç¼–è¾‘
    function saveTask(taskId) {
        const [taskIndex, subTaskIndex] = taskId.split('-').map(Number);
        const data = getSystemData();
        const task = data.tasks.find(t => t.id === taskIndex);

        if (!task) return;

        // å°è¯•ä»è¡¨æ ¼è§†å›¾è·å–æ•°æ®
        let staffId, projectId, taskDesc, status;
        
        const staffElement = document.getElementById(`editStaff-${taskId}`);
        const projectElement = document.getElementById(`editProject-${taskId}`);
        const taskDescElement = document.getElementById(`editTaskDesc-${taskId}`);
        const statusElement = document.getElementById(`editStatus-${taskId}`);

        // å¦‚æœè¡¨æ ¼è§†å›¾çš„å…ƒç´ å­˜åœ¨ï¼Œä½¿ç”¨è¡¨æ ¼è§†å›¾çš„æ•°æ®
        if (staffElement && projectElement && taskDescElement && statusElement) {
            staffId = parseInt(staffElement.value);
            projectId = parseInt(projectElement.value);
            taskDesc = taskDescElement.value;
            status = statusElement.value;
        } else {
            // å¦åˆ™ä½¿ç”¨å¡ç‰‡è§†å›¾çš„æ•°æ®
            staffId = parseInt(document.getElementById(`editStaffCard-${taskId}`).value);
            projectId = parseInt(document.getElementById(`editProjectCard-${taskId}`).value);
            taskDesc = document.getElementById(`editTaskDescCard-${taskId}`).value;
            status = document.getElementById(`editStatusCard-${taskId}`).value;
        }

        // æ›´æ–°ä»»åŠ¡ä¿¡æ¯
        task.staff = staffId;
        task.project = projectId;

        const [mainTask, description] = taskDesc.split(':');
        task.tasks[subTaskIndex].mainTask = mainTask.trim();
        task.tasks[subTaskIndex].description = description ? description.trim() : '';
        task.tasks[subTaskIndex].status = status;

        saveSystemData(data);
        cloudPush(DATA_KEY, data);
        editingTaskId = null;

        // åˆ·æ–°ç•Œé¢
        updateTeamTasksTable(data.tasks);
        updateProjectGantt(data.projects);
        initChart(data.projects);

        alert('ä»»åŠ¡æ›´æ–°æˆåŠŸï¼');
    }

    // å–æ¶ˆç¼–è¾‘
    function cancelEdit(taskId) {
        editingTaskId = null;
        updateTeamTasksTable(getSystemData().tasks);
    }

    // åˆ é™¤ä»»åŠ¡
    function deleteTask(taskId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;

        const [taskIndex, subTaskIndex] = taskId.split('-').map(Number);
        const data = getSystemData();
        const task = data.tasks.find(t => t.id === taskIndex);

        if (!task) return;

        // åˆ é™¤å­ä»»åŠ¡
        task.tasks.splice(subTaskIndex, 1);

        // å¦‚æœæ²¡æœ‰å­ä»»åŠ¡äº†ï¼Œåˆ é™¤æ•´ä¸ªä»»åŠ¡
        if (task.tasks.length === 0) {
            data.tasks = data.tasks.filter(t => t.id !== taskIndex);
        }

        saveSystemData(data);
        cloudPush(DATA_KEY, data);
        updateTeamTasksTable(data.tasks);
        updateProjectGantt(data.projects);
        initChart(data.projects);
        alert('ä»»åŠ¡åˆ é™¤æˆåŠŸï¼');
    }

    // å¼ºåˆ¶åˆ é™¤ç‰¹å®šä»»åŠ¡ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    function forceDeleteTask(taskId) {
        if (!confirm(`ç¡®å®šè¦å¼ºåˆ¶åˆ é™¤ä»»åŠ¡IDä¸º ${taskId} çš„ä»»åŠ¡å—ï¼Ÿ`)) return;
        
        const data = getSystemData();
        console.log('åˆ é™¤å‰çš„ä»»åŠ¡æ•°æ®:', data.tasks);
        
        // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å­˜åœ¨
        const taskExists = data.tasks.some(t => t.id === parseInt(taskId));
        if (!taskExists) {
            alert(`ä»»åŠ¡ID ${taskId} ä¸å­˜åœ¨ï¼`);
            return;
        }
        
        // ç›´æ¥é€šè¿‡IDåˆ é™¤ä»»åŠ¡
        data.tasks = data.tasks.filter(t => t.id !== parseInt(taskId));
        
        console.log('åˆ é™¤åçš„ä»»åŠ¡æ•°æ®:', data.tasks);
        saveSystemData(data);
        cloudPush(DATA_KEY, data);
        
        // åˆ·æ–°ç•Œé¢
        updateTeamTasksTable(data.tasks);
        updateProjectGantt(data.projects);
        initChart(data.projects);
        
        alert(`ä»»åŠ¡ID ${taskId} å·²å¼ºåˆ¶åˆ é™¤ï¼`);
        
        // å¼ºåˆ¶åˆ·æ–°é¡µé¢ä»¥ç¡®ä¿æ•°æ®æ›´æ–°
        setTimeout(() => {
            location.reload();
        }, 1000);
    }

    // æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    function viewAllTasks() {
        const data = getSystemData();
        console.log('æ‰€æœ‰ä»»åŠ¡æ•°æ®:', data.tasks);
        
        let taskInfo = 'å½“å‰æ‰€æœ‰ä»»åŠ¡:\n';
        data.tasks.forEach(task => {
            taskInfo += `ä»»åŠ¡ID: ${task.id}, æ—¥æœŸ: ${task.date}, å‘˜å·¥ID: ${task.staff}\n`;
            task.tasks.forEach((subTask, index) => {
                taskInfo += `  - å­ä»»åŠ¡${index}: ${subTask.mainTask} - ${subTask.description} (${subTask.status})\n`;
            });
        });
        
        alert(taskInfo);
    }

    // æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡ï¼ˆç´§æ€¥æ¸…ç†åŠŸèƒ½ï¼‰
    function clearAllTasks() {
        if (!confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ä»»åŠ¡æ•°æ®ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) return;
        
        const data = getSystemData();
        data.tasks = [];
        saveSystemData(data);
        cloudPush(DATA_KEY, data);
        
        // åˆ·æ–°ç•Œé¢
        updateTeamTasksTable(data.tasks);
        updateProjectGantt(data.projects);
        initChart(data.projects);
        
        alert('æ‰€æœ‰ä»»åŠ¡å·²æ¸…ç©ºï¼');
        
        // å¼ºåˆ¶åˆ·æ–°é¡µé¢
        setTimeout(() => {
            location.reload();
        }, 1000);
    }

    // ä¿®å¤ä»»åŠ¡IDé—®é¢˜ï¼ˆå¤„ç†å­—ç¬¦ä¸²å’Œæ•°å­—ç±»å‹ä¸åŒ¹é…ï¼‰
    function fixTaskIdIssue() {
        const data = getSystemData();
        console.log('ä¿®å¤å‰çš„ä»»åŠ¡æ•°æ®:', data.tasks);
        
        // ç¡®ä¿æ‰€æœ‰ä»»åŠ¡IDéƒ½æ˜¯æ•°å­—ç±»å‹
        data.tasks.forEach(task => {
            if (typeof task.id === 'string') {
                task.id = parseInt(task.id);
            }
        });
        
        // åˆ é™¤ç‰¹å®šçš„é—®é¢˜ä»»åŠ¡ï¼ˆå°è¯•å¤šç§æ–¹å¼ï¼‰
        const targetId = 1756261185209;
        data.tasks = data.tasks.filter(t => {
            const taskId = typeof t.id === 'string' ? parseInt(t.id) : t.id;
            return taskId !== targetId;
        });
        
        console.log('ä¿®å¤åçš„ä»»åŠ¡æ•°æ®:', data.tasks);
        saveSystemData(data);
        
        // åˆ·æ–°ç•Œé¢
        updateTeamTasksTable(data.tasks);
        updateProjectGantt(data.projects);
        initChart(data.projects);
        
        alert('ä»»åŠ¡IDé—®é¢˜å·²ä¿®å¤ï¼Œé—®é¢˜ä»»åŠ¡å·²åˆ é™¤ï¼');
        
        // å¼ºåˆ¶åˆ·æ–°é¡µé¢
        setTimeout(() => {
            location.reload();
        }, 1000);
    }

    // è§†å›¾åˆ‡æ¢åŠŸèƒ½
    function switchView(viewType) {
        const tableView = document.getElementById('tableView');
        const cardView = document.getElementById('cardView');
        const tableViewBtn = document.getElementById('tableViewBtn');
        const cardViewBtn = document.getElementById('cardViewBtn');

        if (viewType === 'table') {
            tableView.style.display = 'block';
            cardView.style.display = 'none';
            tableViewBtn.classList.add('active');
            cardViewBtn.classList.remove('active');
        } else {
            tableView.style.display = 'none';
            cardView.style.display = 'block';
            tableViewBtn.classList.remove('active');
            cardViewBtn.classList.add('active');
        }
    }

    // æ›´æ–°é¡¹ç›®ç”˜ç‰¹å›¾
    function updateProjectGantt(projects) {
        const container = document.getElementById('projectGanttContainer');
        container.innerHTML = '<h3>ğŸ“Š é¡¹ç›®è¿›åº¦ç”˜ç‰¹å›¾</h3>';

        projects.forEach(p => {
            const item = document.createElement('div');
            item.className = 'project-item';

            const title = document.createElement('div');
            title.textContent = p.name;
            title.style.marginBottom = '5px';
            title.style.fontWeight = 'bold';
            item.appendChild(title);

            const progressBar = document.createElement('div');
            progressBar.style.width = '100%';
            progressBar.style.background = '#eee';
            progressBar.style.borderRadius = '3px';
            progressBar.style.height = '20px';
            progressBar.style.position = 'relative';

            const bar = document.createElement('div');
            bar.className = 'gantt-bar';
            bar.style.width = `${p.progress}%`;
            bar.style.height = '100%';
            bar.style.background = p.progress > 70 ? '#2ecc71' :
                p.progress > 30 ? '#3498db' : '#e74c3c';
            bar.style.borderRadius = '3px';

            const percentText = document.createElement('div');
            percentText.style.position = 'absolute';
            percentText.style.top = '0';
            percentText.style.left = '0';
            percentText.style.width = '100%';
            percentText.style.textAlign = 'center';
            percentText.style.color = p.progress > 50 ? 'white' : 'black';
            percentText.style.lineHeight = '20px';
            percentText.textContent = `${p.progress}%`;

            progressBar.appendChild(bar);
            progressBar.appendChild(percentText);
            item.appendChild(progressBar);

            const info = document.createElement('div');
            info.style.marginTop = '5px';
            info.style.fontSize = '14px';
            info.textContent = `è´Ÿè´£äºº: ${p.manager}`;
            item.appendChild(info);

            container.appendChild(item);
        });
    }

    // æ·»åŠ ä»»åŠ¡è¡Œ
    function addTaskRow() {
        const mainTask = document.getElementById('mainTask').value;
        const taskDesc = document.getElementById('taskDesc').value;

        if (!mainTask || !taskDesc) {
            alert("è¯·å¡«å†™å®Œæ•´çš„ä»»åŠ¡ä¿¡æ¯ï¼");
            return;
        }

        const tbody = document.querySelector('#taskTableBody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
                <td>${mainTask}: ${taskDesc}</td>
                <td>
                    <select class="task-input">
                        <option>æœªå¼€å§‹</option>
                        <option selected>è¿›è¡Œä¸­</option>
                        <option>å·²å®Œæˆ</option>
                        <option>å·²é˜»å¡</option>
                    </select>
                </td>
                <td><button class="danger" onclick="this.parentNode.parentNode.remove()">åˆ é™¤</button></td>
            `;
        tbody.appendChild(newRow);
        document.getElementById('taskDesc').value = '';
    }

    // æäº¤æ¯æ—¥ä»»åŠ¡
    function submitDailyForm(data) {
        const date = document.getElementById('taskDate').value;
        const staffId = parseInt(document.getElementById('staff').value);
        const projectId = parseInt(document.getElementById('project').value);

        if(!staffId || !projectId) {
            alert('è¯·é€‰æ‹©å§“åå’Œé¡¹ç›®');
            return;
        }

        const taskRows = document.querySelectorAll('#taskTableBody tr');
        if(taskRows.length === 0) {
            alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªä»»åŠ¡');
            return;
        }

        const newTasks = Array.from(taskRows).map(row => ({
            mainTask: row.cells[0].textContent.split(':')[0].trim(),
            description: row.cells[0].textContent.split(':')[1].trim(),
            status: row.cells[1].querySelector('select').value
        }));

        // åˆ›å»ºæ–°ä»»åŠ¡å¯¹è±¡
        const newTask = {
            id: Date.now(),
            date,
            staff: staffId,
            project: projectId,
            tasks: newTasks
        };

        data.tasks.push(newTask);

        // æ›´æ–°é¡¹ç›®è¿›åº¦
        const project = data.projects.find(p => p.id === projectId);
        if (project) {
            const completedTasks = newTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
            project.progress = Math.min(100, project.progress + (completedTasks * 5));
        }

        saveSystemData(data);
        alert('ä»»åŠ¡æäº¤æˆåŠŸï¼');
        document.querySelector('#taskTableBody').innerHTML = '';
        updateTeamTasksTable(data.tasks);
        updateProjectGantt(data.projects);
        initChart(data.projects);
    }

    // æ·»åŠ é¡¹ç›®
    function addProject() {
        const name = document.getElementById('newProjectName').value.trim();
        const manager = document.getElementById('newProjectManager').value.trim();

        if(!name || !manager) {
            alert('è¯·å¡«å†™é¡¹ç›®åç§°å’Œè´Ÿè´£äºº');
            return;
        }

        const data = getSystemData();
        const newProject = {
            id: Date.now(),
            name,
            manager,
            progress: 0
        };

        data.projects.push(newProject);
        saveSystemData(data);

        document.getElementById('newProjectName').value = '';
        document.getElementById('newProjectManager').value = '';
        updateProjectList(data.projects);
        updateProjectSelect(data.projects);
        updateProjectGantt(data.projects);
        initChart(data.projects);
    }

    // åˆ é™¤é¡¹ç›®
    function deleteProject(projectId) {
        if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ')) return;

        const data = getSystemData();
        data.projects = data.projects.filter(p => p.id !== projectId);
        saveSystemData(data);

        updateProjectList(data.projects);
        updateProjectSelect(data.projects);
        updateProjectGantt(data.projects);
        initChart(data.projects);
    }

    // æ·»åŠ æˆå‘˜
    function addStaff() {
        const name = document.getElementById('newStaffName').value.trim();
        if(!name) {
            alert('è¯·è¾“å…¥å§“å');
            return;
        }

        const data = getSystemData();
        if(data.staff.some(s => s.name === name)) {
            alert('è¯¥æˆå‘˜å·²å­˜åœ¨');
            return;
        }

        const newStaff = {
            id: Date.now(),
            name,
            projects: []
        };

        data.staff.push(newStaff);
        saveSystemData(data);

        document.getElementById('newStaffName').value = '';
        updateStaffList(data.staff, data.projects);
        updateStaffSelect(data.staff);
    }

    // åˆ é™¤æˆå‘˜
    function deleteStaff(staffId) {
        if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæˆå‘˜å—ï¼Ÿ')) return;

        const data = getSystemData();

        // æ‰¾åˆ°è¢«åˆ æˆå‘˜ï¼Œä¿æŠ¤ç®¡ç†å‘˜è´¦å·
        const target = (data.staff || []).find(s => s.id === staffId);
        if (target && target.name === 'ç®¡ç†å‘˜') {
            alert('ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦å·');
            return;
        }

        // ä»æˆå‘˜åˆ—è¡¨ç§»é™¤
        data.staff = (data.staff || []).filter(s => s.id !== staffId);
        saveSystemData(data);

        // åŒæ­¥ä»ç”¨æˆ·è¡¨ä¸­ç§»é™¤å¯¹åº”è´¦å·ï¼Œé˜²æ­¢ç»§ç»­ç™»å½•
        const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        if (target && users[target.name]) {
            delete users[target.name];
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
        }

        updateStaffList(data.staff, data.projects);
        updateStaffSelect(data.staff);
    }

    // é€€å‡ºç™»å½•
    function logout() {
        currentUser = null;
        document.getElementById('mainSystem').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('loginError').textContent = '';
    }

    // å¯¼å‡ºæ•°æ®åˆ°æ–‡ä»¶
    function exportData() {
        const rawUsers = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        const systemData = JSON.parse(localStorage.getItem(DATA_KEY) || '{}');
        
        // ä»ç”¨æˆ·æ•°æ®ä¸­ç§»é™¤å¯†ç å­—æ®µ
        const users = {};
        Object.keys(rawUsers).forEach(username => {
            const { password, ...rest } = rawUsers[username] || {};
            users[username] = rest;
        });
        
        const exportData = {
            users: users,
            systemData: systemData,
            exportDate: new Date().toISOString(),
            version: '1.0'
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `BIMç³»ç»Ÿæ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½åˆ°æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹ã€‚');
    }

    // å¯¼å…¥æ•°æ®
    function importData() {
        if (!confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
            return;
        }
        // æ ¹æ®å½“å‰é¡µé¢çŠ¶æ€é€‰æ‹©æ–‡ä»¶è¾“å…¥æ¡†
        if (document.getElementById('mainSystem').style.display === 'block') {
            document.getElementById('importFileMain').click();
        } else {
            document.getElementById('importFile').click();
        }
    }

    // å¤„ç†æ–‡ä»¶å¯¼å…¥
    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                
                if (importData.users && importData.systemData) {
                    localStorage.setItem(USERS_KEY, JSON.stringify(importData.users));
                    localStorage.setItem(DATA_KEY, JSON.stringify(importData.systemData));
                    
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†é‡æ–°åŠ è½½ã€‚');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„æ•°æ®æ–‡ä»¶ã€‚');
                }
            } catch (error) {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚');
                console.error('Import error:', error);
            }
        };
        reader.readAsText(file);
        
        // æ¸…é™¤æ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
        event.target.value = '';
    }

    // é‡ç½®ç®¡ç†å‘˜è´¦å·
    function resetAdminAccount() {
        if (!confirm('ç¡®å®šè¦é‡ç½®ç®¡ç†å‘˜è´¦å·å—ï¼Ÿè¿™å°†é‡æ–°åˆ›å»ºç®¡ç†å‘˜è´¦å·ã€‚')) {
            return;
        }
        
        // æ¸…é™¤ç°æœ‰çš„ç”¨æˆ·æ•°æ®
        localStorage.removeItem(USERS_KEY);
        
        // é‡æ–°åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
        initUsersData();

        // æ¨é€äº‘ç«¯
        const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        cloudPush(USERS_KEY, users);
        
        // è®¾ç½®é»˜è®¤çš„ç™»å½•ä¿¡æ¯
        document.getElementById('username').value = 'ç®¡ç†å‘˜';
        document.getElementById('password').value = '123456';
        
        alert('ç®¡ç†å‘˜è´¦å·å·²é‡ç½®ï¼\nç”¨æˆ·åï¼šç®¡ç†å‘˜\nå¯†ç ï¼š123456');
    }

    // æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿
    function showAdminPanel() {
        // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
        if (!currentUser || currentUser.role !== 'admin') {
            alert('âš ï¸ æƒé™ä¸è¶³ï¼åªæœ‰ç®¡ç†å‘˜æ‰èƒ½è®¿é—®æ­¤åŠŸèƒ½ï¼');
            return;
        }
        
        const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        console.log('å½“å‰ç”¨æˆ·æ•°æ®:', users);
        
        let userInfo = 'ğŸ” ç®¡ç†å‘˜é¢æ¿ - ç”¨æˆ·æ•°æ®\n\n';
        Object.keys(users).forEach(username => {
            const user = users[username];
            const decryptedPassword = simpleDecrypt(user.password);
            userInfo += `ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯:\n`;
            userInfo += `   ç”¨æˆ·å: ${username}\n`;
            userInfo += `   å§“å: ${user.name}\n`;
            userInfo += `   è§’è‰²: ${user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šæˆå‘˜'}\n`;
            userInfo += `   å¯†ç : ${decryptedPassword}\n`;
            userInfo += `\n`;
        });
        
        userInfo += `ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:\n`;
        userInfo += `   æ€»ç”¨æˆ·æ•°: ${Object.keys(users).length}\n`;
        userInfo += `   ç®¡ç†å‘˜æ•°: ${Object.values(users).filter(u => u.role === 'admin').length}\n`;
        userInfo += `   æ™®é€šæˆå‘˜æ•°: ${Object.values(users).filter(u => u.role === 'staff').length}\n`;
        
        alert(userInfo);
    }
</script>
</body>
</html>
